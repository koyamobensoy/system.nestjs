<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTask | Activity Logs</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <div style="background: var(--light-sage); width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; transform: rotate(-10deg);">
                <i class="fas fa-leaf" style="font-size: 35px; color: var(--primary);"></i>
            </div>
            <h1>EduTask</h1>
            <p id="auth-title">Welcome back, Student!</p>
            
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email Address" required style="margin-bottom: 15px;">
                <button type="submit" class="btn-primary" style="width: 100%;">
                    Sign In <i class="fas fa-arrow-right" style="margin-left: 10px;"></i>
                </button>
                <p style="margin-top: 20px; font-size: 13px;">New here? <a href="#" onclick="toggleAuth(true)" style="color: var(--primary); font-weight: 700; text-decoration: none;">Create an account</a></p>
            </form>

            <form id="registerForm" style="display: none;">
                <div class="profile-upload" onclick="getEl('fileInput').click()" style="margin: 0 auto 25px; width: 90px; height: 90px; border-radius: 50%; border: 3px dashed var(--accent); padding: 5px; cursor: pointer; position: relative;">
                    <img id="preview" src="https://via.placeholder.com/90" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    <div style="position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: white; width: 25px; height: 25px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-camera"></i></div>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImage(this)">
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <input type="text" id="regName" placeholder="Full Name" required>
                    <input type="email" id="regEmail" placeholder="Email Address" required>
                    <select id="regCourse" required>
                        <option value="" disabled selected>Select Your Course</option>
                        <option>BS Criminology</option>
                        <option>BS Education</option>
                        <option>BS Sugar Technology</option>
                        <option>BS Agri Business</option>
                        <option>BS Information Technology</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px; background: var(--secondary);">
                    Register Now
                </button>
                <p style="margin-top: 20px; font-size: 13px;">Already registered? <a href="#" onclick="toggleAuth(false)" style="color: var(--primary); font-weight: 700; text-decoration: none;">Login</a></p>
            </form>
        </div>
    </div>

    <div id="main-dashboard">
        <div class="sidebar" id="sidebar">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 40px;">
                <i class="fas fa-leaf" style="font-size: 24px; color: var(--accent);"></i>
                <h2 style="margin: 0; font-size: 22px; letter-spacing: -1px;">EduTask</h2>
            </div>

            <div class="user-info-box">
                <img id="nav-profile-img" src="https://via.placeholder.com/40">
                <div style="overflow: hidden;">
                    <div id="nav-name" style="font-weight: 700; font-size: 14px; white-space: nowrap; text-overflow: ellipsis;">User</div>
                    <div id="nav-course" style="font-size: 11px; color: var(--accent); opacity: 0.9;">Course</div>
                </div>
            </div>

            <div class="nav-item active" onclick="showSection('schedule', event)"><i class="fas fa-calendar-alt"></i> My Schedule</div>
            <div class="nav-item" onclick="showSection('assignments', event)"><i class="fas fa-tasks"></i> Assignments</div>
            <div class="nav-item" onclick="showSection('students', event)"><i class="fas fa-users"></i> Activity Logs</div>
            
            <button onclick="location.reload()" style="margin-top: auto; background: rgba(255,255,255,0.1); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer;">
                <i class="fas fa-power-off" style="margin-right: 10px;"></i> Sign Out
            </button>
        </div>

        <div class="content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <h2 style="margin: 0; font-weight: 800; font-size: 28px; color: var(--primary);">Hello, <span id="display-name" style="color: var(--secondary);">Student</span>! ðŸ‘‹</h2>
                </div>
                <div id="current-date" style="color: var(--text-light); font-weight: 500;"></div>
            </header>

            <section id="schedule" class="section active">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <div class="card">
                        <h3 style="margin-top: 0; font-size: 18px;"><i class="fas fa-plus-circle" style="color: var(--accent);"></i> Add Class</h3>
                        <form id="scheduleForm" style="display: flex; flex-direction: column; gap: 15px;">
                            <input type="text" id="subject" placeholder="Subject Name" required>
                            <input type="text" id="room" placeholder="Room or Meeting Link" required>
                            <div style="display: flex; gap: 10px;">
                                <input type="time" id="schedTime" required>
                                <select id="day">
                                    <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option>
                                </select>
                            </div>
                            <button type="submit" class="btn-primary">Add to Calendar</button>
                        </form>
                    </div>
                    <div class="card">
                        <table id="scheduleTable">
                            <thead><tr><th>Subject</th><th>Location</th><th>Time</th><th>Day</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="assignments" class="section">
                <div class="card" id="formContainer" style="max-width: 700px; margin: 0 auto 30px;">
                    <h3 style="margin-top: 0;"><i class="fas fa-paper-plane" style="color: var(--primary);"></i> Post New Task</h3>
                    <form id="assignmentForm">
                        <input type="text" id="assignTitle" placeholder="Topic / Module Title" style="margin-bottom: 15px;" required>
                        <textarea id="assignDesc" rows="3" placeholder="Explain the task instructions here..." style="margin-bottom: 15px; resize: none;"></textarea>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-light);">TIME LIMIT (MINS)</label>
                                <input type="number" id="assignTimer" value="30" style="margin-top: 5px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-light);">ATTACHMENT</label>
                                <label for="assignFile" style="cursor:pointer; display:flex; align-items:center; gap:10px; padding:11px; border:2px solid var(--light-sage); border-radius:10px; background:white; margin-top: 5px;">
                                    <i class="fas fa-file-alt" style="color: var(--accent);"></i> 
                                    <span id="file-label" style="font-size:13px; color:#666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Select File</span>
                                </label>
                                <input type="file" id="assignFile" hidden onchange="getEl('file-label').innerText = this.files[0].name">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Broadcast Assignment</button>
                    </form>
                </div>
                <div id="assignmentList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;"></div>
            </section>

            <section id="students" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Student Activity Records</h3>
                        <button class="btn-primary" onclick="loadUsers()" style="padding: 8px 16px; font-size: 12px;"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Student Information</th><th>Academic Track</th><th>Status</th><th style="text-align: right;">Management</th></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        const getEl = id => document.getElementById(id);

        // Date Display
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        getEl('current-date').innerText = new Date().toLocaleDateString(undefined, options);

        function toggleAuth(isRegister) {
            getEl('loginForm').style.display = isRegister ? 'none' : 'block';
            getEl('registerForm').style.display = isRegister ? 'block' : 'none';
            getEl('auth-title').innerText = isRegister ? 'Join the Community' : 'Welcome back, Student!';
        }

        // DATABASE LOGIC (Kept as requested)
        getEl('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = getEl('loginEmail').value;
            try {
                const response = await fetch('https://systemnestjs-production-ba76.up.railway.app/users/display');
                const users = await response.json();
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
                if (user) {
                    enterDashboard(user.name, user.email, "BS Information Technology");
                } else {
                    alert("Email not found. Please register first.");
                }
            } catch(e) { alert("Server Error."); }
        };

        getEl('registerForm').onsubmit = async (e) => {
    e.preventDefault();
    const name = getEl('regName').value;
    const email = getEl('regEmail').value;
    const course = getEl('regCourse').value;
    try {
        const resCheck = await fetch('https://systemnestjs-production-ba76.up.railway.app/users/display');
        const users = await resCheck.json();
        if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
            alert("Email already registered!");
            return;
        }
        await fetch('https://systemnestjs-production-ba76.up.railway.app/users/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, email })
        });
        alert("Registration Successful! Please log in.");
        // Ipakita ang login form
        toggleAuth(false);
        // I-reset ang registration fields
        getEl('regName').value = '';
        getEl('regEmail').value = '';
        getEl('regCourse').selectedIndex = 0;
        getEl('preview').src = "https://via.placeholder.com/90"; 
    } catch(e) { 
        alert("Registration Failed."); 
    }
};
        function enterDashboard(name, email, course) {
            getEl('display-name').innerText = name;
            getEl('nav-name').innerText = name;
            getEl('nav-course').innerText = course;
            getEl('login-overlay').style.opacity = '0';
            setTimeout(() => getEl('login-overlay').style.display = 'none', 500);
            getEl('main-dashboard').style.display = 'flex';
            loadUsers();
        }

        async function loadUsers() {
            try {
                const response = await fetch('https://systemnestjs-production-ba76.up.railway.app/users/display');
                const users = await response.json();
                const course = getEl('nav-course').innerText;
                getEl('tableBody').innerHTML = users.map(user => `
                    <tr id="row-${user.id}">
                        <td>
                            <div style="font-weight: 700; color: var(--primary); font-size: 15px;">${user.name}</div>
                            <div style="font-size: 12px; color: var(--text-light);">${user.email}</div>
                        </td>
                        <td><span style="font-size: 13px; font-weight: 600; color: var(--secondary);">${course}</span></td>
                        <td><span class="status-badge status-active"><i class="fas fa-circle" style="font-size: 7px;"></i> Online Now</span></td>
                        <td style="text-align: right;">
                            <button style="background: #fff0f0; color: var(--danger); padding: 8px 12px; border-radius: 8px; cursor: pointer;" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>`).join('');
            } catch(e) {}
        }

        async function deleteUser(id) {
            if (!confirm('Permanently delete student record?')) return;
            await fetch(`https://systemnestjs-production-ba76.up.railway.app/users/${id}`, { method: 'DELETE' });
            getEl(`row-${id}`).style.opacity = '0';
            setTimeout(() => getEl(`row-${id}`).remove(), 300);
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    getEl('preview').src = e.target.result;
                    getEl('nav-profile-img').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showSection(id, event) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            getEl(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function toggleSidebar() { getEl('sidebar').classList.toggle('collapsed'); }

        getEl('assignmentForm').onsubmit = (e) => {
            e.preventDefault();
            const title = getEl('assignTitle').value;
            const desc = getEl('assignDesc').value;
            const minutes = getEl('assignTimer').value;
            const file = getEl('assignFile').files[0];
            const id = Date.now();
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    createTaskCard(id, title, desc, minutes, file.name, ev.target.result);
                };
                reader.readAsText(file);
            } else {
                createTaskCard(id, title, desc, minutes, "None", "No additional resources provided.");
            }
            getEl('formContainer').style.display = 'none';
        };

        function createTaskCard(id, title, desc, minutes, fileName, fileContent) {
            const cardHTML = `<div class="card" id="task-${id}" style="border-top: 4px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
                    <h4 style="margin:0; color:var(--primary); font-size:20px; font-weight: 800;">${title}</h4>
                    <span class="timer-box"><i class="fas fa-stopwatch"></i> <span id="time-${id}">${minutes}:00</span></span>
                </div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--text-light);">${desc}</p>
                <div class="file-viewer">${fileContent}</div>
                <textarea id="answer-${id}" placeholder="Compose your answer here..." style="min-height: 100px; margin-bottom: 15px;"></textarea>
                <button class="btn-primary" style="width: 100%;" onclick="submitTask(${id})">Turn In Assignment</button>
            </div>`;
            getEl('assignmentList').insertAdjacentHTML('afterbegin', cardHTML);
            startTimer(minutes * 60, `time-${id}`);
        }

        function startTimer(duration, displayId) {
            let timer = duration;
            const interval = setInterval(() => {
                let min = Math.floor(timer / 60);
                let sec = timer % 60;
                const el = document.getElementById(displayId);
                if (!el) { clearInterval(interval); return; }
                el.textContent = (min < 10 ? "0" + min : min) + ":" + (sec < 10 ? "0" + sec : sec);
                if (--timer < 0) { clearInterval(interval); el.textContent = "CLOSED"; el.parentElement.style.background = "#f1f3f5"; el.parentElement.style.color = "#adb5bd"; }
            }, 1000);
        }

        getEl('scheduleForm').onsubmit = (e) => {
            e.preventDefault();
            const row = `<tr>
                <td><strong style="color: var(--primary)">${getEl('subject').value}</strong></td>
                <td><span style="color: var(--text-light)"><i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i> ${getEl('room').value}</span></td>
                <td><span class="status-badge" style="background: var(--light-sage); color: var(--primary)">${getEl('schedTime').value}</span></td>
                <td><span style="font-weight: 600;">${getEl('day').value}</span></td>
            </tr>`;
            document.querySelector('#scheduleTable tbody').innerHTML += row;
            e.target.reset();
        };
    </script>
</body>
</html>