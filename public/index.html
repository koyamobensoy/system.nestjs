<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTask | Activity Logs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="main.css">
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <div style="background: var(--light-sage); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <i class="fas fa-leaf" style="font-size: 30px; color: var(--primary);"></i>
            </div>
            <h1>EduTask</h1>
            <p id="auth-title">Student Login</p>
            
            <form id="loginForm">
                <div style="text-align: left; display: flex; flex-direction: column; gap: 12px;">
                    <input type="email" id="loginEmail" placeholder="Registered Email Address" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px; padding: 12px;">
                    Login <i class="fas fa-sign-in-alt"></i>
                </button>
                <p style="font-size: 12px; margin-top: 15px;">No account yet? <a href="#" onclick="toggleAuth(true)" style="color: var(--primary); font-weight: bold;">Register here</a></p>
            </form>

            <form id="registerForm" style="display: none;">
                <div class="profile-upload" onclick="getEl('fileInput').click()" style="margin: 0 auto 20px; width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); overflow: hidden; cursor: pointer; position: relative;">
                    <img id="preview" src="https://via.placeholder.com/90" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="position: absolute; bottom: 0; background: rgba(0,0,0,0.4); width: 100%; color: white; font-size: 9px; padding: 3px 0;">UPLOAD</div>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImage(this)">
                </div>
                <div style="text-align: left; display: flex; flex-direction: column; gap: 12px;">
                    <input type="text" id="regName" placeholder="Full Name" required>
                    <input type="email" id="regEmail" placeholder="Email Address" required>
                    <select id="regCourse" required>
                        <option value="" disabled selected>Select Your Course</option>
                        <option>BS Criminology</option>
                        <option>BS Education</option>
                        <option>BS Sugar Technology</option>
                        <option>BS Agri Business</option>
                        <option>BS Animal Science</option>
                        <option>BS Information Technology</option>
                        <option>BS Engineering</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px; padding: 12px; background: var(--secondary);">
                    Create Account <i class="fas fa-user-plus"></i>
                </button>
                <p style="font-size: 12px; margin-top: 15px;">Already have an account? <a href="#" onclick="toggleAuth(false)" style="color: var(--primary); font-weight: bold;">Login</a></p>
            </form>
        </div>
    </div>

    <div id="main-dashboard">
        <div class="sidebar" id="sidebar">
            <h2>EduTask</h2>
            <p>Student Task System</p>
            <div class="user-info-box">
                <img id="nav-profile-img" src="https://via.placeholder.com/40">
                <div>
                    <div id="nav-name" style="font-weight: bold; font-size: 14px;">User</div>
                    <div id="nav-course" style="font-size: 11px; color: var(--accent);">Course</div>
                </div>
            </div>
            <div class="nav-item active" onclick="showSection('schedule', event)"><i class="fas fa-calendar-alt"></i> Schedule</div>
            <div class="nav-item" onclick="showSection('assignments', event)"><i class="fas fa-folder-open"></i> Assignments</div>
            <div class="nav-item" onclick="showSection('students', event)"><i class="fas fa-user-graduate"></i> Students Activity</div>
            <button onclick="location.reload()" style="margin-top: auto; background: rgba(255,255,255,0.05); color: white; width: 100%; padding: 12px; font-size: 13px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <div class="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <button onclick="toggleSidebar()" style="background:var(--light-sage); color:var(--primary); padding: 10px 15px;"><i class="fas fa-bars"></i></button>
                <h2 style="margin: 0;">Welcome, <span id="display-name" style="color: var(--secondary);">Student</span>!</h2>
            </div>

            <section id="schedule" class="section active">
                <div class="card">
                    <h3 style="color: var(--primary); margin-top: 0;"><i class="fas fa-plus-circle"></i> New Schedule</h3>
                    <form id="scheduleForm">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <input type="text" id="subject" placeholder="Subject Name" required>
                            <input type="text" id="room" placeholder="Room/Link" required>
                            <input type="time" id="schedTime" required>
                            <select id="day">
                                <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">Save Schedule</button>
                    </form>
                </div>
                <div class="card">
                    <table id="scheduleTable">
                        <thead><tr><th>Subject</th><th>Location</th><th>Time</th><th>Day</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="assignments" class="section">
                <div class="card" id="formContainer">
                    <h3 style="color: var(--primary); margin-top: 0;"><i class="fas fa-folder-plus"></i> Post Assignment</h3>
                    <form id="assignmentForm">
                        <input type="text" id="assignTitle" placeholder="Topic Title" style="margin-bottom: 15px;" required>
                        <textarea id="assignDesc" rows="3" placeholder="Task instructions..." style="margin-bottom: 15px;"></textarea>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 12px; color: var(--secondary); font-weight: 600;">Time Limit (Mins)</label>
                                <input type="number" id="assignTimer" value="30">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--secondary); font-weight: 600;">Resources</label>
                                <label for="assignFile" style="cursor:pointer; display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #e0eadd; border-radius:10px; background:white;">
                                    <i class="fas fa-folder-open" style="color: #ffca28; font-size: 18px;"></i> 
                                    <span id="file-label" style="font-size:13px; color:#666;">Select File</span>
                                </label>
                                <input type="file" id="assignFile" hidden onchange="getEl('file-label').innerText = this.files[0].name">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Launch Assignment</button>
                    </form>
                </div>
                <div id="assignmentList"></div>
            </section>

            <section id="students" class="section">
                <div class="card">
                    <h3 style="color: var(--primary); margin-top: 0;"><i class="fas fa-list-ul"></i> Student Activity Logs</h3>
                    <table>
                        <thead>
                            <tr><th>Student Info</th><th>Course Details</th><th>Recent Activity</th><th>Action</th></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        const getEl = id => document.getElementById(id);

        // Helper: Toggle between Login and Register
        function toggleAuth(isRegister) {
            getEl('loginForm').style.display = isRegister ? 'none' : 'block';
            getEl('registerForm').style.display = isRegister ? 'block' : 'none';
            getEl('auth-title').innerText = isRegister ? 'Student Registration' : 'Student Login';
        }

        // --- AUTH LOGIC ---
        
        // LOGIN logic
        getEl('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = getEl('loginEmail').value;
            
            try {
                const response = await fetch('http://localhost:3000/users/display');
                const users = await response.json();
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());

                if (user) {
                    enterDashboard(user.name, user.email, "BS Information Technology"); // Note: You might want to save/get course from DB too
                } else {
                    alert("Email not found. Please register first.");
                }
            } catch(e) { alert("Server Error."); }
        };

        // REGISTER logic
        getEl('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = getEl('regName').value;
            const email = getEl('regEmail').value;
            const course = getEl('regCourse').value;

            try {
                // Check if email already exists
                const resCheck = await fetch('http://localhost:3000/users/display');
                const users = await resCheck.json();
                if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                    alert("Email already registered!");
                    return;
                }

                // Save to DB
                await fetch('http://localhost:3000/users/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, email })
                });

                alert("Registration Successful! logging you in...");
                enterDashboard(name, email, course);
            } catch(e) { alert("Registration Failed."); }
        };

        function enterDashboard(name, email, course) {
            getEl('display-name').innerText = name;
            getEl('nav-name').innerText = name;
            getEl('nav-course').innerText = course;
            getEl('login-overlay').style.opacity = '0';
            setTimeout(() => getEl('login-overlay').style.display = 'none', 500);
            getEl('main-dashboard').style.display = 'flex';
            loadUsers();
        }

        // --- EXISTING LOGIC (KEEPING EVERYTHING ELSE) ---

        async function loadUsers() {
            try {
                const response = await fetch('http://localhost:3000/users/display');
                const users = await response.json();
                const course = getEl('nav-course').innerText;
                getEl('tableBody').innerHTML = users.map(user => `
                    <tr id="row-${user.id}">
                        <td>
                            <div style="font-weight: bold; color: var(--primary);">#${user.id} - ${user.name}</div>
                            <div style="font-size: 11px; color: #777;">${user.email}</div>
                        </td>
                        <td><span style="font-size: 13px; font-weight: 600;">${course}</span></td>
                        <td><span class="status-badge status-active"><i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i> Active Session</span></td>
                        <td><button class="btn-delete" onclick="deleteUser(${user.id})"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`).join('');
            } catch(e) {}
        }

        async function deleteUser(id) {
            if (!confirm('Permanently delete student record?')) return;
            await fetch(`http://localhost:3000/users/${id}`, { method: 'DELETE' });
            getEl(`row-${id}`).remove();
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    getEl('preview').src = e.target.result;
                    getEl('nav-profile-img').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showSection(id, event) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            getEl(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'students') loadUsers();
        }

        function toggleSidebar() { getEl('sidebar').classList.toggle('collapsed'); }

        // (Assignment and Schedule logic remains exactly the same as your original)
        getEl('assignmentForm').onsubmit = (e) => {
            e.preventDefault();
            const title = getEl('assignTitle').value;
            const desc = getEl('assignDesc').value;
            const minutes = getEl('assignTimer').value;
            const file = getEl('assignFile').files[0];
            const id = Date.now();
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    let content = ev.target.result;
                    createTaskCard(id, title, desc, minutes, file.name, content);
                };
                reader.readAsText(file);
            } else {
                createTaskCard(id, title, desc, minutes, "None", "No additional resources.");
            }
            getEl('formContainer').style.display = 'none';
        };

        function createTaskCard(id, title, desc, minutes, fileName, fileContent) {
            const cardHTML = `<div class="card" id="task-${id}" style="border-left: 5px solid var(--secondary);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h4 style="margin:0; color:var(--primary); font-size:18px;">${title}</h4>
                    <span class="timer-box"><i class="fas fa-clock"></i> <span id="time-${id}">${minutes}:00</span></span>
                </div>
                <p><strong>Instruction:</strong> ${desc}</p>
                <div class="file-viewer">${fileContent}</div>
                <textarea id="answer-${id}" placeholder="Type answer..."></textarea>
                <button class="btn-accent" onclick="submitTask(${id})">Submit</button>
            </div>`;
            getEl('assignmentList').insertAdjacentHTML('afterbegin', cardHTML);
            startTimer(minutes * 60, `time-${id}`);
        }

        function startTimer(duration, displayId) {
            let timer = duration;
            const interval = setInterval(() => {
                let min = Math.floor(timer / 60);
                let sec = timer % 60;
                const el = document.getElementById(displayId);
                if (!el) { clearInterval(interval); return; }
                el.textContent = (min < 10 ? "0" + min : min) + ":" + (sec < 10 ? "0" + sec : sec);
                if (--timer < 0) { clearInterval(interval); el.textContent = "CLOSED"; }
            }, 1000);
        }

        getEl('scheduleForm').onsubmit = (e) => {
            e.preventDefault();
            const row = `<tr><td><strong>${getEl('subject').value}</strong></td><td>${getEl('room').value}</td><td>${getEl('schedTime').value}</td><td>${getEl('day').value}</td></tr>`;
            document.querySelector('#scheduleTable tbody').innerHTML += row;
            e.target.reset();
        };
    </script>
</body>
</html>